<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時間割共有アプリ</title>
    <style>
        /* ハンバーガーとメニュー */
.hamburger {
  font-size: 28px;
  cursor: pointer;
  display: none;
}

.side-menu {
  position: fixed;
  top: 0;
  left: -250px;
  width: 220px;
  height: 100%;
  background: #667eea;
  color: white;
  padding-top: 60px;
  transition: 0.3s;
  z-index: 3000;
}

.side-menu ul {
  list-style: none;
}

.side-menu li {
  padding: 15px 20px;
  cursor: pointer;
  font-weight: 600;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.side-menu li:hover {
  background: rgba(255,255,255,0.2);
}

.side-menu.active {
  left: 0;
}

/* スマホ時にハンバーガーを表示 */
@media (max-width: 768px) {
  .hamburger {
    display: block;
  }
  .tabs {
    display: none;
  }
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .login-container {
            padding: 60px 30px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tabs {
            display: flex;
            background: #f3f4f6;
            padding: 10px;
            gap: 10px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .content {
            padding: 30px;
        }
        
        .schedule-container {
            overflow-x: auto;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .schedule-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .schedule-table td {
            border: 1px solid #e5e7eb;
            padding: 10px;
            min-height: 80px;
            vertical-align: top;
        }
        /* 24時間時間割用の微調整 */
.schedule-table td {
  height: 25px; /* 30分刻み1マス */
  position: relative;
}

.schedule-item {
  background: #e0e7ff;
  color: #1e3a8a;
  border-radius: 4px;
  overflow: hidden;
  font-size: 12px;
  text-align: center;
  transition: 0.2s;
  box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}

/* 少し段をずらすために縦線を目立たせる */
.schedule-table th, .schedule-table td {
  border: 1px solid #ddd;
}

        
        .time-cell {
            background: #f9fafb;
            font-weight: 600;
            text-align: center;
            width: 120px;
        }
        
        .schedule-item {
            background: #e0e7ff;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 13px;
            color: #1e40af;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-item:hover {
            background: #c7d2fe;
            transform: scale(1.02);
        }
        
        .add-time-slot {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .event-list {
            display: grid;
            gap: 15px;
        }
        
        .event-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .event-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .event-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .event-date {
            color: #6b7280;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .event-details {
            color: #374151;
            margin: 10px 0;
            line-height: 1.6;
        }
        
        .event-members {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .member-badge {
            padding: 6px 12px;
            background: #e0e7ff;
            border-radius: 20px;
            font-size: 13px;
            color: #4338ca;
        }
        
        .member-badge.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .member-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .group-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .group-badge {
            padding: 8px 15px;
            background: #e0e7ff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .group-badge:hover {
            border-color: #667eea;
        }
        
        .group-badge.active {
            background: #667eea;
            color: white;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ログイン画面 -->
        <div id="loginScreen">
            <div class="login-container">
                <h1 style="text-align: center; margin-bottom: 30px; color: #667eea;">📅 時間割共有アプリ</h1>
                <div class="login-form">
                    <div class="form-group">
                        <label>ログインID</label>
                        <input type="text" id="loginId" placeholder="IDを入力">
                    </div>
                    <div class="form-group">
                        <label>パスワード</label>
                        <input type="password" id="loginPassword" placeholder="パスワードを入力">
                    </div>
                    <button class="btn btn-primary" onclick="login()">ログイン</button>
                    <button class="btn btn-secondary" onclick="register()">新規登録</button>
                </div>
            </div>
        </div>

        <!-- メイン画面 -->
        <div id="mainScreen" class="hidden">
            <div class="header">
  <div style="display: flex; align-items: center; gap: 15px;">
    <div class="hamburger" onclick="toggleMenu()">☰</div>
    <h1>📅 時間割共有アプリ</h1>
  </div>
  <div class="user-info">
    <span id="currentUser"></span>
    <button class="btn btn-secondary" onclick="logout()">ログアウト</button>
  </div>
</div>

<!-- ハンバーガーメニュー本体 -->
<nav id="sideMenu" class="side-menu">
  <ul>
    <li onclick="openPage('schedule')">📅 マイ時間割</li>
    <li onclick="openPage('events')">👥 グループ予定</li>
    <li onclick="openPage('notifications')">🔔 通知</li>
    <li onclick="openPage('groups')">🏫 グループ管理</li>
    <li onclick="openPage('sharedView')">👀 他ユーザーの時間割</li>
    <li onclick="logout()">🚪 ログアウト</li>
  </ul>
</nav>


            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'schedule')">マイ時間割</button>
                <button class="tab" onclick="switchTab(event, 'events')">グループ予定</button>
                <button class="tab" onclick="switchTab(event, 'notifications')">通知</button>
                <button class="tab" onclick="switchTab(event, 'groups')">グループ管理</button>
            </div>

            <div class="content">
            <!-- 👀 他ユーザー時間割タブ -->
<div id="sharedViewTab" class="hidden">
  <h2 style="margin-bottom: 20px;">👀 他ユーザーの時間割を見る</h2>
    <div class="add-time-slot" style="align-items:center; gap:10px;">
    <div class="form-group">
      <label>ユーザーID（UID）</label>
      <input type="text" id="sharedUserId" placeholder="共有相手のUIDを入力">
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="viewSharedSchedule()">表示</button>
      <button class="btn btn-danger" onclick="resetSharedView()">🔁 クリア（共有表示）</button>
    </div>
  </div>

  <div class="schedule-container">
    <table class="schedule-table">
      <thead>
        <tr>
          <th>時間</th>
          <th>月</th>
          <th>火</th>
          <th>水</th>
          <th>木</th>
          <th>金</th>
        </tr>
      </thead>
      <tbody id="sharedScheduleBody"></tbody>
    </table>
  </div>
</div>
    
          <!-- 時間割タブ -->
<div id="scheduleTab">
  <div style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;">
    <button class="btn btn-secondary" onclick="shareSchedule()">📤 この時間割を共有</button>
    <button class="btn btn-danger" onclick="resetSchedule()">🔁 全リセット（時間割）</button>
  </div>

  <h2 style="margin-bottom: 20px;">週間時間割</h2>
  <div class="add-time-slot">
      <!-- （以下、時間割フォームとテーブルはそのまま） -->
  </div>
</div>

                    <h2 style="margin-bottom: 20px;">週間時間割</h2>
                    <div class="add-time-slot">
                        <div class="form-group">
                            <label>曜日</label>
                            <select id="daySelect">
                                <option value="月">月曜日</option>
                                <option value="火">火曜日</option>
                                <option value="水">水曜日</option>
                                <option value="木">木曜日</option>
                                <option value="金">金曜日</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>開始時間</label>
                            <input type="time" id="startTime">
                        </div>
                        <div class="form-group">
                            <label>終了時間</label>
                            <input type="time" id="endTime">
                        </div>
                        <div class="form-group">
                            <label>内容</label>
                            <input type="text" id="scheduleContent" placeholder="授業名など">
                        </div>
                        <button class="btn btn-primary" onclick="addSchedule()">追加</button>
                    </div>
                    <div class="schedule-container">
                        <table class="schedule-table" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>月</th>
                                    <th>火</th>
                                    <th>水</th>
                                    <th>木</th>
                                    <th>金</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- グループ予定タブ -->
                <div id="eventsTab" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>グループ予定</h2>
                        <button class="btn btn-primary" onclick="showCreateEventModal()">+ 新しい予定を作成</button>
                    </div>
                    <div class="group-list" id="eventGroupFilter"></div>
                    <div class="event-list" id="eventList"></div>
                </div>

                <!-- 通知タブ -->
                <div id="notificationsTab" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <h2>通知</h2>
  <button class="btn btn-danger" onclick="resetNotifications()">🔁 全リセット（通知）</button>
</div>

                    <div class="event-list" id="notificationList"></div>
                </div>

                <!-- グループ管理タブ -->
                <div id="groupsTab" class="hidden">
                    <h2 style="margin-bottom: 20px;">グループ管理</h2>
                   <div class="add-time-slot" style="align-items:center;">
    <div class="form-group">
        <label>グループ名</label>
        <input type="text" id="groupName" placeholder="例: クラス1A">
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="createGroup()">グループ作成</button>
      <button class="btn btn-danger" onclick="resetGroups()">🔁 全リセット（グループ）</button>
    </div>
</div>

                        <button class="btn btn-primary" onclick="createGroup()">グループ作成</button>
                    </div>
                    <div class="event-list" id="groupsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 予定作成モーダル -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">新しい予定を作成</div>
            <div class="login-form">
                <div class="form-group">
                    <label>グループ選択</label>
                    <select id="eventGroupSelect"></select>
                </div>
                <div class="form-group">
                    <label>予定名</label>
                    <input type="text" id="eventTitle" placeholder="例: 飲み会">
                </div>
                <div class="form-group">
                    <label>日付</label>
                    <input type="date" id="eventDate">
                </div>
                <div class="form-group">
                    <label>時間</label>
                    <input type="time" id="eventTime">
                </div>
                <div class="form-group">
                    <label>詳細</label>
                    <textarea id="eventDetails" rows="4" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; width: 100%;"></textarea>
                </div>
                <div class="form-group">
                    <label>必須参加人数</label>
                    <input type="number" id="minParticipants" min="1" value="1">
                </div>
            

            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div id="notification" class="notification"></div>

    <script>
        // データストア
        const data = {
            users: {},
            schedules: {},
            events: [],
            groups: {},
            notifications: {}
        };
        
        let currentUser = null;
        let currentFilter = '';

        // 通知表示
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('active');
            setTimeout(() => {
                notif.classList.remove('active');
            }, 3000);
        }

       // 新規登録
async function register() {
  const id = document.getElementById('loginId').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!id || !password) {
    showNotification('IDとパスワードを入力してください');
    return;
  }

  try {
    // メール形式に変換（Firebase用）
    await firebaseCreateUser(firebaseAuth, id + "@example.com", password);
    showNotification('登録完了！ログインしてください');
    document.getElementById('loginPassword').value = '';
  } catch (error) {
    showNotification('登録に失敗: ' + error.message);
  }
}


        // ログイン処理
 // ログイン
async function login() {
  const id = document.getElementById('loginId').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!id || !password) {
    showNotification('IDとパスワードを入力してください');
    return;
  }

  try {
    const userCredential = await firebaseSignIn(firebaseAuth, id + "@example.com", password);
    const user = userCredential.user;
    currentUser = user.uid; // Firebase UID を使用
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ユーザー: ${id}`;
    loadSchedule();
    loadEvents();
    loadNotifications();
    loadGroups();// ✅ Firebaseからユーザーごとのデータを取得
const userRef = firebaseRef(firebaseDB, `users/${currentUser}`);
firebaseOnValue(userRef, (snapshot) => {
  const val = snapshot.val();
  if (val) {
    data.schedules[currentUser] = val.schedules || {};
    data.notifications[currentUser] = val.notifications || [];
    data.groups = val.groups || {};
    data.events = val.events || [];
  } else {
    // 初回ログイン時（まだデータが無い場合）
    data.schedules[currentUser] = {};
    data.notifications[currentUser] = [];
    data.groups = {};
    data.events = [];
  }

  loadSchedule();
  loadGroups();
  loadEvents();
  loadNotifications();
});


onAuthStateChanged(firebaseAuth, (user) => {
  if (user) {
    currentUser = user.uid;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ユーザー: ${user.email.split('@')[0]}`;
    
    // 🔹 再ログイン時もFirebaseからデータを再読込
    const userRef = firebaseRef(firebaseDB, `users/${currentUser}`);
    firebaseOnValue(userRef, (snapshot) => {
      const val = snapshot.val() || {};
      data.schedules[currentUser] = val.schedules || {};
      data.notifications[currentUser] = val.notifications || [];
      data.groups = val.groups || {};
      data.events = val.events || [];
      loadSchedule();
      loadGroups();
      loadEvents();
      loadNotifications();
    });
  }
});

    showNotification('ログインしました');
  } catch (error) {
    showNotification('ログインに失敗: ' + error.message);
  }
}


        // ログアウト
        async function logout() {
  await firebaseSignOut(firebaseAuth);
  currentUser = null;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainScreen').classList.add('hidden');
  showNotification('ログアウトしました');
}


        // タブ切り替え
        function switchTab(e, tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            
            document.getElementById('scheduleTab').classList.add('hidden');
            document.getElementById('eventsTab').classList.add('hidden');
            document.getElementById('notificationsTab').classList.add('hidden');
            document.getElementById('groupsTab').classList.add('hidden');
            
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            if (tab === 'events') loadEvents();
            if (tab === 'notifications') loadNotifications();
            if (tab === 'groups') loadGroups();
        }

        // 時間割追加
        function addSchedule() {
            const day = document.getElementById('daySelect').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const content = document.getElementById('scheduleContent').value;
            
            if (!start || !end || !content) {
                showNotification('すべての項目を入力してください');
                return;
            }
            
            if (!data.schedules[currentUser]) {
                data.schedules[currentUser] = {};
            }
            
            const timeKey = `${start}-${end}`;
            if (!data.schedules[currentUser][timeKey]) {
                data.schedules[currentUser][timeKey] = {};
            }
            
            data.schedules[currentUser][timeKey][day] = content;
            
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('scheduleContent').value = '';
            
            loadSchedule();
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/schedules`),
  data.schedules[currentUser]
);
// 🔹 Firebaseにスケジュールを保存

            showNotification('時間割を追加しました');
        }

// 時間割読み込み（24時間・30分刻み固定表示）
function loadSchedule() {
  const schedule = data.schedules[currentUser] || {};
  const tbody = document.getElementById('scheduleBody');
  tbody.innerHTML = '';

  const days = ['月', '火', '水', '木', '金', '土', '日'];

  // 0:00〜24:00を30分刻みで生成
  const times = [];
  for (let h = 0; h < 24; h++) {
    times.push(`${String(h).padStart(2, '0')}:00`);
    times.push(`${String(h).padStart(2, '0')}:30`);
  }

  // 行を生成
  times.forEach((time, i) => {
    const row = document.createElement('tr');
    const timeCell = document.createElement('td');
    timeCell.className = 'time-cell';
    timeCell.innerHTML = time;
    row.appendChild(timeCell);

    days.forEach(day => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';
      cell.style.height = '25px'; // 1マスの高さ
      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  // スケジュールを配置
  Object.entries(schedule).forEach(([timeRange, dayData]) => {
    const [start, end] = timeRange.split('-');
    const startIndex = times.findIndex(t => t === start);
    const endIndex = times.findIndex(t => t === end);
    if (startIndex === -1 || endIndex === -1) return;

    const duration = endIndex - startIndex || 1;
    const height = duration * 25; // 各30分あたり25pxの高さ

    days.forEach((day, dayIndex) => {
      const content = dayData[day];
      if (content) {
        const row = tbody.rows[startIndex];
        if (!row) return;
        const cell = row.cells[dayIndex + 1];
        const block = document.createElement('div');
        block.className = 'schedule-item';
        block.textContent = content;
        block.style.position = 'absolute';
        block.style.top = '0';
        block.style.left = '0';
        block.style.width = '100%';
        block.style.height = `${height}px`;
        block.style.background = '#c7d2fe';
        block.style.borderRadius = '4px';
        block.style.fontSize = '12px';
        block.style.padding = '2px 4px';
        block.style.boxSizing = 'border-box';
        block.style.overflow = 'hidden';
        block.style.cursor = 'pointer';
        block.onclick = () => {
          if (confirm(`「${content}」を削除しますか？`)) {
            delete dayData[day];
            if (Object.keys(dayData).length === 0) delete schedule[timeRange];
            firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/schedules`), schedule);
            loadSchedule();
            showNotification('削除しました');
          }
        };
        cell.appendChild(block);
      }
    });
  });
}



        // グループ作成
        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                showNotification('グループ名を入力してください');
                return;
            }
            
            const groupId = 'group_' + Date.now();
            data.groups[groupId] = {
                name: name,
                creator: currentUser,
                members: [currentUser]
            };
            
            document.getElementById('groupName').value = '';
            loadGroups();
            showNotification('グループを作成しました');
// 🔹 Firebaseにグループを保存
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/groups`),
  data.groups
);

        }

        // グループ読み込み
        function loadGroups() {
            const list = document.getElementById('groupsList');
            list.innerHTML = '';
            
            Object.entries(data.groups).forEach(([id, group]) => {
                if (group.members.includes(currentUser)) {
                    const card = document.createElement('div');
                    card.className = 'event-card';
                   function deleteGroup(groupId) {
  if (!confirm('このグループを削除しますか？')) return;

  if (data.groups[groupId] && data.groups[groupId].creator === currentUser) {
    delete data.groups[groupId];
    firebaseSet(firebaseRef(firebaseDB, `groups`), data.groups)
      .then(() => {
        firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/groups`), data.groups);
        loadGroups();
        showNotification('グループを削除しました');
      })
      .catch(() => showNotification('グループの削除に失敗しました'));
  } else {
    showNotification('このグループを削除する権限がありません');
  }
}

                    list.appendChild(card);
                }
            });
            
            updateEventGroupSelects();
        }

        // メンバー追加
        function addMember(groupId) {
            const memberId = document.getElementById(`member_${groupId}`).value.trim();
            if (!memberId) {
                showNotification('メンバーIDを入力してください');
                return;
            }
            
            if (!data.users[memberId]) {
                showNotification('存在しないユーザーです');
                return;
            }
            
            if (data.groups[groupId].members.includes(memberId)) {
                showNotification('既にメンバーに含まれています');
                return;
            }
            
            data.groups[groupId].members.push(memberId);
            loadGroups();
            showNotification('メンバーを追加しました');
        }

        // イベント作成モーダル表示
        function showCreateEventModal() {
            const hasGroups = Object.values(data.groups).some(g => g.members.includes(currentUser));
            if (!hasGroups) {
                showNotification('先にグループを作成してください');
                return;
            }
            document.getElementById('createEventModal').classList.add('active');
        }

        // モーダルを閉じる
        function closeModal() {
            document.getElementById('createEventModal').classList.remove('active');
        }

        // グループセレクト更新
        function updateEventGroupSelects() {
            const select = document.getElementById('eventGroupSelect');
            const filter = document.getElementById('eventGroupFilter');
            select.innerHTML = '<option value="">グループを選択</option>';
            filter.innerHTML = '<div class="group-badge active" onclick="filterEvents(\'\', event)">すべて</div>';
            
            Object.entries(data.groups).forEach(([id, group]) => {
                if (group.members.includes(currentUser)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = group.name;
                    select.appendChild(option);
                    
                    const badge = document.createElement('div');
                    badge.className = 'group-badge';
                    badge.textContent = group.name;
                    badge.onclick = (e) => filterEvents(id, e);
                    filter.appendChild(badge);
                }
            });
        }

        // イベント作成
        function createEvent() {
            const groupId = document.getElementById('eventGroupSelect').value;
            const title = document.getElementById('eventTitle').value.trim();
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const details = document.getElementById('eventDetails').value;
            const minParticipants = parseInt(document.getElementById('minParticipants').value);
            
            if (!groupId || !title || !date || !time) {
                showNotification('必須項目を入力してください');
                return;
            }
            
const event = {
  id: 'event_' + Date.now(),
  groupId: groupId,
  title: title,
  date: date,
  time: time,
  details: details,
  minParticipants: minParticipants,
  host: currentUser,
  participants: {}
};

data.events.push(event);

// 🔹 Firebaseにイベントを保存
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/events`),
  data.events
);

            
            
            // グループメンバーに通知
            data.groups[groupId].members.forEach(member => {
                if (member !== currentUser) {
                    if (!data.notifications[member]) {
                        data.notifications[member] = [];
                    }
                    data.notifications[member].push({
                        id: 'notif_' + Date.now() + '_' + member,
                        eventId: event.id,
                        type: 'invitation',
                        message: `${data.groups[groupId].name}の予定「${title}」に招待されました`,
                        date: date,
                        time: time
                    });
                }
            });
            // 🔹 通知をFirebaseへ保存（全ユーザー分）
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/notifications`),
  data.notifications[currentUser]
);

            closeModal();
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDetails').value = '';
            document.getElementById('minParticipants').value = '1';
            
            loadEvents();
            showNotification('予定を作成しました');
        }

        // イベントフィルター
        function filterEvents(groupId, e) {
            currentFilter = groupId;
            const badges = document.querySelectorAll('#eventGroupFilter .group-badge');
            badges.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            loadEvents();
        }

        // イベント一覧読み込み
        function loadEvents() {
            const list = document.getElementById('eventList');
            list.innerHTML = '';
            
            const relevantEvents = data.events.filter(e => {
                const group = data.groups[e.groupId];
                if (!group || !group.members.includes(currentUser)) return false;
                if (currentFilter && e.groupId !== currentFilter) return false;
                return true;
            });
            
            relevantEvents.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            if (relevantEvents.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280;">予定はありません</p>';
                return;
            }
            
            relevantEvents.forEach(event => {
                const group = data.groups[event.groupId];
                const participantCount = Object.values(event.participants).filter(p => p).length;
                const status = event.participants[currentUser];
                
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    

                        <div>
                            <div class="event-title">${event.title}</div>
                            <div class="event-date">${event.date} ${event.time} - ${group.name}</div>
                            <div class="event-date">主催: ${event.host}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: ${participantCount >= event.minParticipants ? '#10b981' : '#ef4444'};">
                                参加: ${participantCount}/${event.minParticipants}人
                            </div>
                        </div>
                    </div>
                    <div class="event-details">${event.details || '詳細なし'}</div>
                    <div class="event-members">
                        ${group.members.map(m => {
                            const accepted = event.participants[m];
                            const cls = accepted === true ? 'accepted' : accepted === false ? '' : 'pending';
                            const text = accepted === true ? '✓ ' + m : accepted === false ? '✗ ' + m : m;
                            return `<span class="member-badge ${cls}">${text}</span>`;
                        }).join('')}
                    </div>
                    ${status === undefined ? `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="respondToEvent('${event.id}', true)">参加する</button>
                            <button class="btn btn-danger" onclick="respondToEvent('${event.id}', false)">不参加</button>
                        </div>
                    ` : ''}
                    ${event.host === currentUser && participantCount < event.minParticipants ? `
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="deleteEvent('${event.id}')">予定を削除</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }

        // イベント参加応答
        function respondToEvent(eventId, accept) {
            const event = data.events.find(e => e.id === eventId);
            if (!event) return;
            
            event.participants[currentUser] = accept;
            
            // 主催者に通知
            if (!data.notifications[event.host]) {
                data.notifications[event.host] = [];
            }
            data.notifications[event.host].push({
                id: 'notif_' + Date.now(),
                eventId: eventId,
                type: 'response',
                message: `${currentUser}が予定「${event.title}」に${accept ? '参加' : '不参加'}しました`
            });
            // 🔹 通知をFirebaseへ保存（主催者側）
            firebaseSet(
            firebaseRef(firebaseDB, `users/${event.host}/notifications`),
            data.notifications[event.host]
            );
            // 🔹 通知をFirebaseへ保存（自分側）
            firebaseSet(
            firebaseRef(firebaseDB, `users/${currentUser}/notifications`),
            data.notifications[currentUser]
            );
            loadEvents();
            showNotification(accept ? '参加を承認しました' : '不参加を伝えました');
        }


        // イベント削除
        function deleteEvent(eventId) {
            if (!confirm('この予定を削除しますか？')) return;
            
            const index = data.events.findIndex(e => e.id === eventId);
            if (index > -1) {
                data.events.splice(index, 1);
                loadEvents();
                showNotification('予定を削除しました');
            }
        }

        // 通知読み込み
        function loadNotifications() {
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            const notifs = data.notifications[currentUser] || [];
            
            if (notifs.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280;">通知はありません</p>';
                return;
            }



            notifs.reverse().forEach(notif => {
                const event = data.events.find(e => e.id === notif.eventId);
                if (!event) return;
                
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-title">${notif.message}</div>
                    ${notif.date ? `<div class="event-date">${notif.date} ${notif.time}</div>` : ''}
                    ${notif.type === 'invitation' && event.participants[currentUser] === undefined ? `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="respondToEvent('${event.id}', true); loadNotifications();">参加する</button>
                            <button class="btn btn-danger" onclick="respondToEvent('${event.id}', false); loadNotifications();">不参加</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }
        // 🔹 時間割共有
function shareSchedule() {
  if (!currentUser || !data.schedules[currentUser]) {
    showNotification('共有する時間割がありません');
    return;
  }

  // Firebase に共有用データを保存
  firebaseSet(firebaseRef(firebaseDB, `sharedSchedules/${currentUser}`), data.schedules[currentUser])
    .then(() => {
      const shareUrl = `${location.origin}${location.pathname}?share=${currentUser}`;
      navigator.clipboard.writeText(shareUrl);
      showNotification('共有リンクをコピーしました！');
      alert('このリンクを相手に送ってください：\n\n' + shareUrl);
    })
    .catch(() => showNotification('共有に失敗しました'));
}

        // 🔹 URLパラメータで共有表示
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  const sharedUser = params.get('share');

  if (sharedUser) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `共有表示中 (${sharedUser})`;

    const userRef = firebaseRef(firebaseDB, `sharedSchedules/${sharedUser}`);
    firebaseOnValue(userRef, (snapshot) => {
      const schedule = snapshot.val() || {};
      data.schedules['shared'] = schedule;
      currentUser = 'shared';
      loadSchedule();
      showNotification('共有された時間割を表示中');
    });

    // 編集ボタンを無効化
    const addButton = document.querySelector('.add-time-slot button');
    if (addButton) addButton.disabled = true;
  }
});
// 🔹 ハンバーガーメニュー操作
function toggleMenu() {
  document.getElementById('sideMenu').classList.toggle('active');
}

function openPage(tab) {
  document.getElementById('sideMenu').classList.remove('active');

  document.getElementById('scheduleTab').classList.add('hidden');
  document.getElementById('eventsTab').classList.add('hidden');
  document.getElementById('notificationsTab').classList.add('hidden');
  document.getElementById('groupsTab').classList.add('hidden');
  document.getElementById('sharedViewTab').classList.add('hidden');

  document.getElementById(tab + 'Tab').classList.remove('hidden');

  if (tab === 'events') loadEvents();
  if (tab === 'notifications') loadNotifications();
  if (tab === 'groups') loadGroups();
}

    </script>
<!-- Firebase Realtime Database 用スクリプト -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    set,
    get,
    onValue,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // 🔽 ここを追加 🔽
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";


  // あなたのFirebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyDJLXuJsjTYNoBC0Uw8TaeTt8H3h3jy-lM",
    authDomain: "schedule-app-f1cab.firebaseapp.com",
    databaseURL: "https://schedule-app-f1cab-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "schedule-app-f1cab",
    storageBucket: "schedule-app-f1cab.firebasestorage.app",
    messagingSenderId: "942123523213",
    appId: "1:942123523213:web:6b31fa2fe42c3924c256c4"
  };

 // Firebase 初期化
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// 🔽 ここを追加
const auth = getAuth(app);

// 🔽 他のスクリプトから使えるように登録
window.firebaseDB = db;
window.firebaseAuth = auth;
window.firebaseRef = ref;
window.firebaseSet = set;
window.firebaseOnValue = onValue;
window.firebaseUpdate = update;
window.firebaseRemove = remove;
window.firebaseCreateUser = createUserWithEmailAndPassword;
window.firebaseSignIn = signInWithEmailAndPassword;
window.firebaseSignOut = signOut;
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (user) {
    window.currentUser = user.uid;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ユーザー: ${user.email.split('@')[0]}`;

    const userRef = ref(db, `users/${user.uid}`);
    onValue(userRef, (snapshot) => {
      const val = snapshot.val() || {};
      data.schedules[user.uid] = val.schedules || {};
      data.notifications[user.uid] = val.notifications || [];
      data.groups = val.groups || {};
      data.events = val.events || [];
      loadSchedule();
      loadGroups();
      loadEvents();
      loadNotifications();
    });
  }
});


  // 他のスクリプトで使えるようにwindowへ登録
  window.firebaseDB = db;
  window.firebaseRef = ref;
  window.firebaseSet = set;
  window.firebaseOnValue = onValue;
  window.firebaseUpdate = update;
  window.firebaseRemove = remove;
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const eventsRef = firebaseRef(firebaseDB, "events");
  const groupsRef = firebaseRef(firebaseDB, "groups");

  firebaseOnValue(eventsRef, (snapshot) => {
    data.events = snapshot.val() || [];
    if (currentUser) loadEvents();
  });

  firebaseOnValue(groupsRef, (snapshot) => {
    data.groups = snapshot.val() || {};
    if (currentUser) loadGroups();
  });
});
    // 🔹 他ユーザーの共有スケジュールを取得して表示
function viewSharedSchedule() {
  const uid = document.getElementById('sharedUserId').value.trim();
  if (!uid) {
    showNotification('ユーザーIDを入力してください');
    return;
  }

  const refShared = firebaseRef(firebaseDB, `sharedSchedules/${uid}`);
  firebaseOnValue(refShared, (snapshot) => {
    const schedule = snapshot.val();
    if (!schedule) {
      showNotification('そのユーザーの共有時間割は見つかりません');
      return;
    }

    const tbody = document.getElementById('sharedScheduleBody');
    tbody.innerHTML = '';
    const times = Object.keys(schedule).sort();
    const days = ['月','火','水','木','金'];

    times.forEach(time => {
      const row = document.createElement('tr');
      const timeCell = document.createElement('td');
      timeCell.className = 'time-cell';
      timeCell.innerHTML = time.replace('-', '<br>～<br>');
      row.appendChild(timeCell);

      days.forEach(day => {
        const cell = document.createElement('td');
        if (schedule[time][day]) {
          const item = document.createElement('div');
          item.className = 'schedule-item';
          item.textContent = schedule[time][day];
          cell.appendChild(item);
        }
        row.appendChild(cell);
      });

      tbody.appendChild(row);
    });

    showNotification('共有時間割を読み込みました');
  });
}
/* ---------- 全リセット系関数（ここをスクリプト内の適切な場所に追加） ---------- */

/** 時間割リセット（現在ユーザーの時間割を空にする） */
function resetSchedule() {
  if (!currentUser) { showNotification('ログインしてください'); return; }
  if (!confirm('本当に時間割を全て削除しますか？元に戻せません。')) return;
  data.schedules[currentUser] = {};
  // Firebase に反映
  firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/schedules`), data.schedules[currentUser])
    .then(() => {
      loadSchedule();
      showNotification('時間割を全てリセットしました');
    })
    .catch(() => showNotification('時間割のリセットに失敗しました'));
}

/** イベント（予定）リセット（自分が主催している予定を削除） */
function resetEvents() {
  if (!currentUser) { showNotification('ログインしてください'); return; }
  if (!confirm('自分が作成した予定を全て削除しますか？（参加者の予定は除く）')) return;
  // data.events が配列で管理されている前提
  data.events = data.events.filter(e => e.host !== currentUser);
  // Firebase のグローバル events を更新
  firebaseSet(firebaseRef(firebaseDB, `events`), data.events)
    .then(() => {
      // 自分自身の users/${uid}/events も空に
      firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/events`), [])
        .then(() => {
          loadEvents();
          showNotification('予定を全てリセットしました');
        })
        .catch(() => {
          loadEvents();
          showNotification('一部のリセット（ユーザ側）に失敗しましたが、グローバル予定は更新しました');
        });
    })
    .catch(() => showNotification('予定のリセットに失敗しました'));
}

/** 通知リセット（自分宛の通知を空にする） */
function resetNotifications() {
  if (!currentUser) { showNotification('ログインしてください'); return; }
  if (!confirm('自分の通知を全て削除しますか？')) return;
  data.notifications[currentUser] = [];
  firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/notifications`), data.notifications[currentUser])
    .then(() => {
      loadNotifications();
      showNotification('通知を全てリセットしました');
    })
    .catch(() => showNotification('通知のリセットに失敗しました'));
}

/** グループリセット（自分が作成したグループを削除し、参加しているグループから自分を外す） */
function resetGroups() {
  if (!currentUser) { showNotification('ログインしてください'); return; }
  if (!confirm('作成したグループを削除し、参加中のグループから自分を外します。続行しますか？')) return;

  const newGroups = {};
  Object.entries(data.groups || {}).forEach(([gid, g]) => {
    // 自分が作成者の場合はグループを削除（＝スキップ）
    if (g.creator === currentUser) {
      return;
    }
    // それ以外はメンバー配列から自分を取り除く
    const members = Array.isArray(g.members) ? g.members.filter(m => m !== currentUser) : [];
    newGroups[gid] = Object.assign({}, g, { members });
  });

  data.groups = newGroups;

  // グローバル groups 更新と自分の users/${uid}/groups 更新
  firebaseSet(firebaseRef(firebaseDB, `groups`), data.groups)
    .then(() => {
      firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/groups`), data.groups)
        .then(() => {
          loadGroups();
          showNotification('グループ情報をリセットしました');
        })
        .catch(() => {
          loadGroups();
          showNotification('グループ（ユーザ側）のリセットに失敗しましたが、グローバルは更新しました');
        });
    })
    .catch(() => showNotification('グループのリセットに失敗しました'));
}

/** 共有表示クリア（sharedView） - 表示中の共有ユーザーID と表示テーブルをクリア */
function resetSharedView() {
  document.getElementById('sharedUserId').value = '';
  const tbody = document.getElementById('sharedScheduleBody');
  if (tbody) tbody.innerHTML = '';
  showNotification('共有表示をクリアしました');
}

/* ---------- ここまで全リセット関数 ---------- */

</script>

</body>
</html>













