<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“å‰²å…±æœ‰ã‚¢ãƒ—ãƒª</title>
    <style>
        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.hamburger {
  font-size: 28px;
  cursor: pointer;
  display: none;
}

.side-menu {
  position: fixed;
  top: 0;
  left: -250px;
  width: 220px;
  height: 100%;
  background: #667eea;
  color: white;
  padding-top: 60px;
  transition: 0.3s;
  z-index: 3000;
}

.side-menu ul {
  list-style: none;
}

.side-menu li {
  padding: 15px 20px;
  cursor: pointer;
  font-weight: 600;
  border-bottom: 1px solid rgba(255,255,255,0.2);
}

.side-menu li:hover {
  background: rgba(255,255,255,0.2);
}

.side-menu.active {
  left: 0;
}

/* ã‚¹ãƒãƒ›æ™‚ã«ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚’è¡¨ç¤º */
@media (max-width: 768px) {
  .hamburger {
    display: block;
  }
  .tabs {
    display: none;
  }
}

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .login-container {
            padding: 60px 30px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #374151;
        }
        
        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tabs {
            display: flex;
            background: #f3f4f6;
            padding: 10px;
            gap: 10px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .content {
            padding: 30px;
        }
        
        .schedule-container {
            overflow-x: auto;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .schedule-table th {
            background: #667eea;
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
        }
        
        .schedule-table td {
            border: 1px solid #e5e7eb;
            padding: 10px;
            min-height: 80px;
            vertical-align: top;
        }
        /* 24æ™‚é–“æ™‚é–“å‰²ç”¨ã®å¾®èª¿æ•´ */
.schedule-table td {
  height: 25px; /* 30åˆ†åˆ»ã¿1ãƒã‚¹ */
  position: relative;
}

.schedule-item {
  background: #e0e7ff;
  color: #1e3a8a;
  border-radius: 4px;
  overflow: hidden;
  font-size: 12px;
  text-align: center;
  transition: 0.2s;
  box-shadow: 0 2px 3px rgba(0,0,0,0.1);
}

/* å°‘ã—æ®µã‚’ãšã‚‰ã™ãŸã‚ã«ç¸¦ç·šã‚’ç›®ç«‹ãŸã›ã‚‹ */
.schedule-table th, .schedule-table td {
  border: 1px solid #ddd;
}

        
        .time-cell {
            background: #f9fafb;
            font-weight: 600;
            text-align: center;
            width: 120px;
        }
        
        .schedule-item {
            background: #e0e7ff;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 13px;
            color: #1e40af;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-item:hover {
            background: #c7d2fe;
            transform: scale(1.02);
        }
        
        .add-time-slot {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }
        
        .event-list {
            display: grid;
            gap: 15px;
        }
        
        .event-card {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .event-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .event-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }
        
        .event-date {
            color: #6b7280;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .event-details {
            color: #374151;
            margin: 10px 0;
            line-height: 1.6;
        }
        
        .event-members {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .member-badge {
            padding: 6px 12px;
            background: #e0e7ff;
            border-radius: 20px;
            font-size: 13px;
            color: #4338ca;
        }
        
        .member-badge.accepted {
            background: #d1fae5;
            color: #065f46;
        }
        
        .member-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s;
        }
        
        .notification.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .group-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .group-badge {
            padding: 8px 15px;
            background: #e0e7ff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .group-badge:hover {
            border-color: #667eea;
        }
        
        .group-badge.active {
            background: #667eea;
            color: white;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
        <div id="loginScreen">
            <div class="login-container">
                <h1 style="text-align: center; margin-bottom: 30px; color: #667eea;">ğŸ“… æ™‚é–“å‰²å…±æœ‰ã‚¢ãƒ—ãƒª</h1>
                <div class="login-form">
                    <div class="form-group">
                        <label>ãƒ­ã‚°ã‚¤ãƒ³ID</label>
                        <input type="text" id="loginId" placeholder="IDã‚’å…¥åŠ›">
                    </div>
                    <div class="form-group">
                        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                    </div>
                    <button class="btn btn-primary" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button class="btn btn-secondary" onclick="register()">æ–°è¦ç™»éŒ²</button>
                </div>
            </div>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
        <div id="mainScreen" class="hidden">
            <div class="header">
  <div style="display: flex; align-items: center; gap: 15px;">
    <div class="hamburger" onclick="toggleMenu()">â˜°</div>
    <h1>ğŸ“… æ™‚é–“å‰²å…±æœ‰ã‚¢ãƒ—ãƒª</h1>
  </div>
  <div class="user-info">
    <span id="currentUser"></span>
    <button class="btn btn-secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>
</div>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æœ¬ä½“ -->
<nav id="sideMenu" class="side-menu">
  <ul>
    <li onclick="openPage('schedule')">ğŸ“… ãƒã‚¤æ™‚é–“å‰²</li>
    <li onclick="openPage('events')">ğŸ‘¥ ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®š</li>
    <li onclick="openPage('notifications')">ğŸ”” é€šçŸ¥</li>
    <li onclick="openPage('groups')">ğŸ« ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</li>
    <li onclick="openPage('sharedView')">ğŸ‘€ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ™‚é–“å‰²</li>
    <li onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
  </ul>
</nav>


            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'schedule')">ãƒã‚¤æ™‚é–“å‰²</button>
                <button class="tab" onclick="switchTab(event, 'events')">ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®š</button>
                <button class="tab" onclick="switchTab(event, 'notifications')">é€šçŸ¥</button>
                <button class="tab" onclick="switchTab(event, 'groups')">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</button>
            </div>

            <div class="content">
            <!-- ğŸ‘€ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚é–“å‰²ã‚¿ãƒ– -->
<div id="sharedViewTab" class="hidden">
  <h2 style="margin-bottom: 20px;">ğŸ‘€ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ™‚é–“å‰²ã‚’è¦‹ã‚‹</h2>
    <div class="add-time-slot" style="align-items:center; gap:10px;">
    <div class="form-group">
      <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUIDï¼‰</label>
      <input type="text" id="sharedUserId" placeholder="å…±æœ‰ç›¸æ‰‹ã®UIDã‚’å…¥åŠ›">
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="viewSharedSchedule()">è¡¨ç¤º</button>
      <button class="btn btn-danger" onclick="resetSharedView()">ğŸ” ã‚¯ãƒªã‚¢ï¼ˆå…±æœ‰è¡¨ç¤ºï¼‰</button>
    </div>
  </div>

  <div class="schedule-container">
    <table class="schedule-table">
      <thead>
        <tr>
          <th>æ™‚é–“</th>
          <th>æœˆ</th>
          <th>ç«</th>
          <th>æ°´</th>
          <th>æœ¨</th>
          <th>é‡‘</th>
        </tr>
      </thead>
      <tbody id="sharedScheduleBody"></tbody>
    </table>
  </div>
</div>
    
          <!-- æ™‚é–“å‰²ã‚¿ãƒ– -->
<div id="scheduleTab">
  <div style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;">
    <button class="btn btn-secondary" onclick="shareSchedule()">ğŸ“¤ ã“ã®æ™‚é–“å‰²ã‚’å…±æœ‰</button>
    <button class="btn btn-danger" onclick="resetSchedule()">ğŸ” å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆæ™‚é–“å‰²ï¼‰</button>
  </div>

  <h2 style="margin-bottom: 20px;">é€±é–“æ™‚é–“å‰²</h2>
  <div class="add-time-slot">
      <!-- ï¼ˆä»¥ä¸‹ã€æ™‚é–“å‰²ãƒ•ã‚©ãƒ¼ãƒ ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ãã®ã¾ã¾ï¼‰ -->
  </div>
</div>

                    <h2 style="margin-bottom: 20px;">é€±é–“æ™‚é–“å‰²</h2>
                    <div class="add-time-slot">
                        <div class="form-group">
                            <label>æ›œæ—¥</label>
                            <select id="daySelect">
                                <option value="æœˆ">æœˆæ›œæ—¥</option>
                                <option value="ç«">ç«æ›œæ—¥</option>
                                <option value="æ°´">æ°´æ›œæ—¥</option>
                                <option value="æœ¨">æœ¨æ›œæ—¥</option>
                                <option value="é‡‘">é‡‘æ›œæ—¥</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="startTime">
                        </div>
                        <div class="form-group">
                            <label>çµ‚äº†æ™‚é–“</label>
                            <input type="time" id="endTime">
                        </div>
                        <div class="form-group">
                            <label>å†…å®¹</label>
                            <input type="text" id="scheduleContent" placeholder="æˆæ¥­åãªã©">
                        </div>
                        <button class="btn btn-primary" onclick="addSchedule()">è¿½åŠ </button>
                    </div>
                    <div class="schedule-container">
                        <table class="schedule-table" id="scheduleTable">
                            <thead>
                                <tr>
                                    <th>æ™‚é–“</th>
                                    <th>æœˆ</th>
                                    <th>ç«</th>
                                    <th>æ°´</th>
                                    <th>æœ¨</th>
                                    <th>é‡‘</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®šã‚¿ãƒ– -->
                <div id="eventsTab" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ã‚°ãƒ«ãƒ¼ãƒ—äºˆå®š</h2>
                        <button class="btn btn-primary" onclick="showCreateEventModal()">+ æ–°ã—ã„äºˆå®šã‚’ä½œæˆ</button>
                    </div>
                    <div class="group-list" id="eventGroupFilter"></div>
                    <div class="event-list" id="eventList"></div>
                </div>

                <!-- é€šçŸ¥ã‚¿ãƒ– -->
                <div id="notificationsTab" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
  <h2>é€šçŸ¥</h2>
  <button class="btn btn-danger" onclick="resetNotifications()">ğŸ” å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆé€šçŸ¥ï¼‰</button>
</div>

                    <div class="event-list" id="notificationList"></div>
                </div>

                <!-- ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ã‚¿ãƒ– -->
                <div id="groupsTab" class="hidden">
                    <h2 style="margin-bottom: 20px;">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</h2>
                   <div class="add-time-slot" style="align-items:center;">
    <div class="form-group">
        <label>ã‚°ãƒ«ãƒ¼ãƒ—å</label>
        <input type="text" id="groupName" placeholder="ä¾‹: ã‚¯ãƒ©ã‚¹1A">
    </div>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-primary" onclick="createGroup()">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
      <button class="btn btn-danger" onclick="resetGroups()">ğŸ” å…¨ãƒªã‚»ãƒƒãƒˆï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ï¼‰</button>
    </div>
</div>

                        <button class="btn btn-primary" onclick="createGroup()">ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
                    </div>
                    <div class="event-list" id="groupsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- äºˆå®šä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="createEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°ã—ã„äºˆå®šã‚’ä½œæˆ</div>
            <div class="login-form">
                <div class="form-group">
                    <label>ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ</label>
                    <select id="eventGroupSelect"></select>
                </div>
                <div class="form-group">
                    <label>äºˆå®šå</label>
                    <input type="text" id="eventTitle" placeholder="ä¾‹: é£²ã¿ä¼š">
                </div>
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="eventDate">
                </div>
                <div class="form-group">
                    <label>æ™‚é–“</label>
                    <input type="time" id="eventTime">
                </div>
                <div class="form-group">
                    <label>è©³ç´°</label>
                    <textarea id="eventDetails" rows="4" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: inherit; width: 100%;"></textarea>
                </div>
                <div class="form-group">
                    <label>å¿…é ˆå‚åŠ äººæ•°</label>
                    <input type="number" id="minParticipants" min="1" value="1">
                </div>
            

            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div id="notification" class="notification"></div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
        const data = {
            users: {},
            schedules: {},
            events: [],
            groups: {},
            notifications: {}
        };
        
        let currentUser = null;
        let currentFilter = '';

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('active');
            setTimeout(() => {
                notif.classList.remove('active');
            }, 3000);
        }

       // æ–°è¦ç™»éŒ²
async function register() {
  const id = document.getElementById('loginId').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!id || !password) {
    showNotification('IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    // ãƒ¡ãƒ¼ãƒ«å½¢å¼ã«å¤‰æ›ï¼ˆFirebaseç”¨ï¼‰
    await firebaseCreateUser(firebaseAuth, id + "@example.com", password);
    showNotification('ç™»éŒ²å®Œäº†ï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
    document.getElementById('loginPassword').value = '';
  } catch (error) {
    showNotification('ç™»éŒ²ã«å¤±æ•—: ' + error.message);
  }
}


        // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
 // ãƒ­ã‚°ã‚¤ãƒ³
async function login() {
  const id = document.getElementById('loginId').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!id || !password) {
    showNotification('IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    const userCredential = await firebaseSignIn(firebaseAuth, id + "@example.com", password);
    const user = userCredential.user;
    currentUser = user.uid; // Firebase UID ã‚’ä½¿ç”¨
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${id}`;
    loadSchedule();
    loadEvents();
    loadNotifications();
    loadGroups();// âœ… Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
const userRef = firebaseRef(firebaseDB, `users/${currentUser}`);
firebaseOnValue(userRef, (snapshot) => {
  const val = snapshot.val();
  if (val) {
    data.schedules[currentUser] = val.schedules || {};
    data.notifications[currentUser] = val.notifications || [];
    data.groups = val.groups || {};
    data.events = val.events || [];
  } else {
    // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼ˆã¾ã ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆï¼‰
    data.schedules[currentUser] = {};
    data.notifications[currentUser] = [];
    data.groups = {};
    data.events = [];
  }

  loadSchedule();
  loadGroups();
  loadEvents();
  loadNotifications();
});


onAuthStateChanged(firebaseAuth, (user) => {
  if (user) {
    currentUser = user.uid;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.email.split('@')[0]}`;
    
    // ğŸ”¹ å†ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‚‚Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­è¾¼
    const userRef = firebaseRef(firebaseDB, `users/${currentUser}`);
    firebaseOnValue(userRef, (snapshot) => {
      const val = snapshot.val() || {};
      data.schedules[currentUser] = val.schedules || {};
      data.notifications[currentUser] = val.notifications || [];
      data.groups = val.groups || {};
      data.events = val.events || [];
      loadSchedule();
      loadGroups();
      loadEvents();
      loadNotifications();
    });
  }
});

    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
  } catch (error) {
    showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—: ' + error.message);
  }
}


        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        async function logout() {
  await firebaseSignOut(firebaseAuth);
  currentUser = null;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainScreen').classList.add('hidden');
  showNotification('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
}


        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(e, tab) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            e.target.classList.add('active');
            
            document.getElementById('scheduleTab').classList.add('hidden');
            document.getElementById('eventsTab').classList.add('hidden');
            document.getElementById('notificationsTab').classList.add('hidden');
            document.getElementById('groupsTab').classList.add('hidden');
            
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            if (tab === 'events') loadEvents();
            if (tab === 'notifications') loadNotifications();
            if (tab === 'groups') loadGroups();
        }

        // æ™‚é–“å‰²è¿½åŠ 
        function addSchedule() {
            const day = document.getElementById('daySelect').value;
            const start = document.getElementById('startTime').value;
            const end = document.getElementById('endTime').value;
            const content = document.getElementById('scheduleContent').value;
            
            if (!start || !end || !content) {
                showNotification('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!data.schedules[currentUser]) {
                data.schedules[currentUser] = {};
            }
            
            const timeKey = `${start}-${end}`;
            if (!data.schedules[currentUser][timeKey]) {
                data.schedules[currentUser][timeKey] = {};
            }
            
            data.schedules[currentUser][timeKey][day] = content;
            
            document.getElementById('startTime').value = '';
            document.getElementById('endTime').value = '';
            document.getElementById('scheduleContent').value = '';
            
            loadSchedule();
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/schedules`),
  data.schedules[currentUser]
);
// ğŸ”¹ Firebaseã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¿å­˜

            showNotification('æ™‚é–“å‰²ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

// æ™‚é–“å‰²èª­ã¿è¾¼ã¿ï¼ˆ24æ™‚é–“ãƒ»30åˆ†åˆ»ã¿å›ºå®šè¡¨ç¤ºï¼‰
function loadSchedule() {
  const schedule = data.schedules[currentUser] || {};
  const tbody = document.getElementById('scheduleBody');
  tbody.innerHTML = '';

  const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];

  // 0:00ã€œ24:00ã‚’30åˆ†åˆ»ã¿ã§ç”Ÿæˆ
  const times = [];
  for (let h = 0; h < 24; h++) {
    times.push(`${String(h).padStart(2, '0')}:00`);
    times.push(`${String(h).padStart(2, '0')}:30`);
  }

  // è¡Œã‚’ç”Ÿæˆ
  times.forEach((time, i) => {
    const row = document.createElement('tr');
    const timeCell = document.createElement('td');
    timeCell.className = 'time-cell';
    timeCell.innerHTML = time;
    row.appendChild(timeCell);

    days.forEach(day => {
      const cell = document.createElement('td');
      cell.style.position = 'relative';
      cell.style.height = '25px'; // 1ãƒã‚¹ã®é«˜ã•
      row.appendChild(cell);
    });

    tbody.appendChild(row);
  });

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é…ç½®
  Object.entries(schedule).forEach(([timeRange, dayData]) => {
    const [start, end] = timeRange.split('-');
    const startIndex = times.findIndex(t => t === start);
    const endIndex = times.findIndex(t => t === end);
    if (startIndex === -1 || endIndex === -1) return;

    const duration = endIndex - startIndex || 1;
    const height = duration * 25; // å„30åˆ†ã‚ãŸã‚Š25pxã®é«˜ã•

    days.forEach((day, dayIndex) => {
      const content = dayData[day];
      if (content) {
        const row = tbody.rows[startIndex];
        if (!row) return;
        const cell = row.cells[dayIndex + 1];
        const block = document.createElement('div');
        block.className = 'schedule-item';
        block.textContent = content;
        block.style.position = 'absolute';
        block.style.top = '0';
        block.style.left = '0';
        block.style.width = '100%';
        block.style.height = `${height}px`;
        block.style.background = '#c7d2fe';
        block.style.borderRadius = '4px';
        block.style.fontSize = '12px';
        block.style.padding = '2px 4px';
        block.style.boxSizing = 'border-box';
        block.style.overflow = 'hidden';
        block.style.cursor = 'pointer';
        block.onclick = () => {
          if (confirm(`ã€Œ${content}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete dayData[day];
            if (Object.keys(dayData).length === 0) delete schedule[timeRange];
            firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/schedules`), schedule);
            loadSchedule();
            showNotification('å‰Šé™¤ã—ã¾ã—ãŸ');
          }
        };
        cell.appendChild(block);
      }
    });
  });
}



        // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
        function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            if (!name) {
                showNotification('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const groupId = 'group_' + Date.now();
            data.groups[groupId] = {
                name: name,
                creator: currentUser,
                members: [currentUser]
            };
            
            document.getElementById('groupName').value = '';
            loadGroups();
            showNotification('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ');
// ğŸ”¹ Firebaseã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä¿å­˜
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/groups`),
  data.groups
);

        }

        // ã‚°ãƒ«ãƒ¼ãƒ—èª­ã¿è¾¼ã¿
        function loadGroups() {
            const list = document.getElementById('groupsList');
            list.innerHTML = '';
            
            Object.entries(data.groups).forEach(([id, group]) => {
                if (group.members.includes(currentUser)) {
                    const card = document.createElement('div');
                    card.className = 'event-card';
                   function deleteGroup(groupId) {
  if (!confirm('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

  if (data.groups[groupId] && data.groups[groupId].creator === currentUser) {
    delete data.groups[groupId];
    firebaseSet(firebaseRef(firebaseDB, `groups`), data.groups)
      .then(() => {
        firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/groups`), data.groups);
        loadGroups();
        showNotification('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      })
      .catch(() => showNotification('ã‚°ãƒ«ãƒ¼ãƒ—ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'));
  } else {
    showNotification('ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
  }
}

                    list.appendChild(card);
                }
            });
            
            updateEventGroupSelects();
        }

        // ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
        function addMember(groupId) {
            const memberId = document.getElementById(`member_${groupId}`).value.trim();
            if (!memberId) {
                showNotification('ãƒ¡ãƒ³ãƒãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!data.users[memberId]) {
                showNotification('å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™');
                return;
            }
            
            if (data.groups[groupId].members.includes(memberId)) {
                showNotification('æ—¢ã«ãƒ¡ãƒ³ãƒãƒ¼ã«å«ã¾ã‚Œã¦ã„ã¾ã™');
                return;
            }
            
            data.groups[groupId].members.push(memberId);
            loadGroups();
            showNotification('ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showCreateEventModal() {
            const hasGroups = Object.values(data.groups).some(g => g.members.includes(currentUser));
            if (!hasGroups) {
                showNotification('å…ˆã«ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦ãã ã•ã„');
                return;
            }
            document.getElementById('createEventModal').classList.add('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('createEventModal').classList.remove('active');
        }

        // ã‚°ãƒ«ãƒ¼ãƒ—ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°
        function updateEventGroupSelects() {
            const select = document.getElementById('eventGroupSelect');
            const filter = document.getElementById('eventGroupFilter');
            select.innerHTML = '<option value="">ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠ</option>';
            filter.innerHTML = '<div class="group-badge active" onclick="filterEvents(\'\', event)">ã™ã¹ã¦</div>';
            
            Object.entries(data.groups).forEach(([id, group]) => {
                if (group.members.includes(currentUser)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = group.name;
                    select.appendChild(option);
                    
                    const badge = document.createElement('div');
                    badge.className = 'group-badge';
                    badge.textContent = group.name;
                    badge.onclick = (e) => filterEvents(id, e);
                    filter.appendChild(badge);
                }
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆ
        function createEvent() {
            const groupId = document.getElementById('eventGroupSelect').value;
            const title = document.getElementById('eventTitle').value.trim();
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const details = document.getElementById('eventDetails').value;
            const minParticipants = parseInt(document.getElementById('minParticipants').value);
            
            if (!groupId || !title || !date || !time) {
                showNotification('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
const event = {
  id: 'event_' + Date.now(),
  groupId: groupId,
  title: title,
  date: date,
  time: time,
  details: details,
  minParticipants: minParticipants,
  host: currentUser,
  participants: {}
};

data.events.push(event);

// ğŸ”¹ Firebaseã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¿å­˜
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/events`),
  data.events
);

            
            
            // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã«é€šçŸ¥
            data.groups[groupId].members.forEach(member => {
                if (member !== currentUser) {
                    if (!data.notifications[member]) {
                        data.notifications[member] = [];
                    }
                    data.notifications[member].push({
                        id: 'notif_' + Date.now() + '_' + member,
                        eventId: event.id,
                        type: 'invitation',
                        message: `${data.groups[groupId].name}ã®äºˆå®šã€Œ${title}ã€ã«æ‹›å¾…ã•ã‚Œã¾ã—ãŸ`,
                        date: date,
                        time: time
                    });
                }
            });
            // ğŸ”¹ é€šçŸ¥ã‚’Firebaseã¸ä¿å­˜ï¼ˆå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†ï¼‰
firebaseSet(
  firebaseRef(firebaseDB, `users/${currentUser}/notifications`),
  data.notifications[currentUser]
);

            closeModal();
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventDetails').value = '';
            document.getElementById('minParticipants').value = '1';
            
            loadEvents();
            showNotification('äºˆå®šã‚’ä½œæˆã—ã¾ã—ãŸ');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        function filterEvents(groupId, e) {
            currentFilter = groupId;
            const badges = document.querySelectorAll('#eventGroupFilter .group-badge');
            badges.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            loadEvents();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§èª­ã¿è¾¼ã¿
        function loadEvents() {
            const list = document.getElementById('eventList');
            list.innerHTML = '';
            
            const relevantEvents = data.events.filter(e => {
                const group = data.groups[e.groupId];
                if (!group || !group.members.includes(currentUser)) return false;
                if (currentFilter && e.groupId !== currentFilter) return false;
                return true;
            });
            
            relevantEvents.sort((a, b) => new Date(a.date + ' ' + a.time) - new Date(b.date + ' ' + b.time));
            
            if (relevantEvents.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280;">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            relevantEvents.forEach(event => {
                const group = data.groups[event.groupId];
                const participantCount = Object.values(event.participants).filter(p => p).length;
                const status = event.participants[currentUser];
                
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    

                        <div>
                            <div class="event-title">${event.title}</div>
                            <div class="event-date">${event.date} ${event.time} - ${group.name}</div>
                            <div class="event-date">ä¸»å‚¬: ${event.host}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: ${participantCount >= event.minParticipants ? '#10b981' : '#ef4444'};">
                                å‚åŠ : ${participantCount}/${event.minParticipants}äºº
                            </div>
                        </div>
                    </div>
                    <div class="event-details">${event.details || 'è©³ç´°ãªã—'}</div>
                    <div class="event-members">
                        ${group.members.map(m => {
                            const accepted = event.participants[m];
                            const cls = accepted === true ? 'accepted' : accepted === false ? '' : 'pending';
                            const text = accepted === true ? 'âœ“ ' + m : accepted === false ? 'âœ— ' + m : m;
                            return `<span class="member-badge ${cls}">${text}</span>`;
                        }).join('')}
                    </div>
                    ${status === undefined ? `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="respondToEvent('${event.id}', true)">å‚åŠ ã™ã‚‹</button>
                            <button class="btn btn-danger" onclick="respondToEvent('${event.id}', false)">ä¸å‚åŠ </button>
                        </div>
                    ` : ''}
                    ${event.host === currentUser && participantCount < event.minParticipants ? `
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="deleteEvent('${event.id}')">äºˆå®šã‚’å‰Šé™¤</button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ å¿œç­”
        function respondToEvent(eventId, accept) {
            const event = data.events.find(e => e.id === eventId);
            if (!event) return;
            
            event.participants[currentUser] = accept;
            
            // ä¸»å‚¬è€…ã«é€šçŸ¥
            if (!data.notifications[event.host]) {
                data.notifications[event.host] = [];
            }
            data.notifications[event.host].push({
                id: 'notif_' + Date.now(),
                eventId: eventId,
                type: 'response',
                message: `${currentUser}ãŒäºˆå®šã€Œ${event.title}ã€ã«${accept ? 'å‚åŠ ' : 'ä¸å‚åŠ '}ã—ã¾ã—ãŸ`
            });
            // ğŸ”¹ é€šçŸ¥ã‚’Firebaseã¸ä¿å­˜ï¼ˆä¸»å‚¬è€…å´ï¼‰
            firebaseSet(
            firebaseRef(firebaseDB, `users/${event.host}/notifications`),
            data.notifications[event.host]
            );
            // ğŸ”¹ é€šçŸ¥ã‚’Firebaseã¸ä¿å­˜ï¼ˆè‡ªåˆ†å´ï¼‰
            firebaseSet(
            firebaseRef(firebaseDB, `users/${currentUser}/notifications`),
            data.notifications[currentUser]
            );
            loadEvents();
            showNotification(accept ? 'å‚åŠ ã‚’æ‰¿èªã—ã¾ã—ãŸ' : 'ä¸å‚åŠ ã‚’ä¼ãˆã¾ã—ãŸ');
        }


        // ã‚¤ãƒ™ãƒ³ãƒˆå‰Šé™¤
        function deleteEvent(eventId) {
            if (!confirm('ã“ã®äºˆå®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const index = data.events.findIndex(e => e.id === eventId);
            if (index > -1) {
                data.events.splice(index, 1);
                loadEvents();
                showNotification('äºˆå®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // é€šçŸ¥èª­ã¿è¾¼ã¿
        function loadNotifications() {
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            const notifs = data.notifications[currentUser] || [];
            
            if (notifs.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #6b7280;">é€šçŸ¥ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }



            notifs.reverse().forEach(notif => {
                const event = data.events.find(e => e.id === notif.eventId);
                if (!event) return;
                
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <div class="event-title">${notif.message}</div>
                    ${notif.date ? `<div class="event-date">${notif.date} ${notif.time}</div>` : ''}
                    ${notif.type === 'invitation' && event.participants[currentUser] === undefined ? `
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="respondToEvent('${event.id}', true); loadNotifications();">å‚åŠ ã™ã‚‹</button>
                            <button class="btn btn-danger" onclick="respondToEvent('${event.id}', false); loadNotifications();">ä¸å‚åŠ </button>
                        </div>
                    ` : ''}
                `;
                list.appendChild(card);
            });
        }
        // ğŸ”¹ æ™‚é–“å‰²å…±æœ‰
function shareSchedule() {
  if (!currentUser || !data.schedules[currentUser]) {
    showNotification('å…±æœ‰ã™ã‚‹æ™‚é–“å‰²ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  // Firebase ã«å…±æœ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  firebaseSet(firebaseRef(firebaseDB, `sharedSchedules/${currentUser}`), data.schedules[currentUser])
    .then(() => {
      const shareUrl = `${location.origin}${location.pathname}?share=${currentUser}`;
      navigator.clipboard.writeText(shareUrl);
      showNotification('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      alert('ã“ã®ãƒªãƒ³ã‚¯ã‚’ç›¸æ‰‹ã«é€ã£ã¦ãã ã•ã„ï¼š\n\n' + shareUrl);
    })
    .catch(() => showNotification('å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ'));
}

        // ğŸ”¹ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å…±æœ‰è¡¨ç¤º
document.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(location.search);
  const sharedUser = params.get('share');

  if (sharedUser) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `å…±æœ‰è¡¨ç¤ºä¸­ (${sharedUser})`;

    const userRef = firebaseRef(firebaseDB, `sharedSchedules/${sharedUser}`);
    firebaseOnValue(userRef, (snapshot) => {
      const schedule = snapshot.val() || {};
      data.schedules['shared'] = schedule;
      currentUser = 'shared';
      loadSchedule();
      showNotification('å…±æœ‰ã•ã‚ŒãŸæ™‚é–“å‰²ã‚’è¡¨ç¤ºä¸­');
    });

    // ç·¨é›†ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const addButton = document.querySelector('.add-time-slot button');
    if (addButton) addButton.disabled = true;
  }
});
// ğŸ”¹ ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ“ä½œ
function toggleMenu() {
  document.getElementById('sideMenu').classList.toggle('active');
}

function openPage(tab) {
  document.getElementById('sideMenu').classList.remove('active');

  document.getElementById('scheduleTab').classList.add('hidden');
  document.getElementById('eventsTab').classList.add('hidden');
  document.getElementById('notificationsTab').classList.add('hidden');
  document.getElementById('groupsTab').classList.add('hidden');
  document.getElementById('sharedViewTab').classList.add('hidden');

  document.getElementById(tab + 'Tab').classList.remove('hidden');

  if (tab === 'events') loadEvents();
  if (tab === 'notifications') loadNotifications();
  if (tab === 'groups') loadGroups();
}

    </script>
<!-- Firebase Realtime Database ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getDatabase,
    ref,
    set,
    get,
    onValue,
    update,
    remove
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // ğŸ”½ ã“ã“ã‚’è¿½åŠ  ğŸ”½
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";


  // ã‚ãªãŸã®Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDJLXuJsjTYNoBC0Uw8TaeTt8H3h3jy-lM",
    authDomain: "schedule-app-f1cab.firebaseapp.com",
    databaseURL: "https://schedule-app-f1cab-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "schedule-app-f1cab",
    storageBucket: "schedule-app-f1cab.firebasestorage.app",
    messagingSenderId: "942123523213",
    appId: "1:942123523213:web:6b31fa2fe42c3924c256c4"
  };

 // Firebase åˆæœŸåŒ–
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ğŸ”½ ã“ã“ã‚’è¿½åŠ 
const auth = getAuth(app);

// ğŸ”½ ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«ç™»éŒ²
window.firebaseDB = db;
window.firebaseAuth = auth;
window.firebaseRef = ref;
window.firebaseSet = set;
window.firebaseOnValue = onValue;
window.firebaseUpdate = update;
window.firebaseRemove = remove;
window.firebaseCreateUser = createUserWithEmailAndPassword;
window.firebaseSignIn = signInWithEmailAndPassword;
window.firebaseSignOut = signOut;
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

onAuthStateChanged(auth, (user) => {
  if (user) {
    window.currentUser = user.uid;
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${user.email.split('@')[0]}`;

    const userRef = ref(db, `users/${user.uid}`);
    onValue(userRef, (snapshot) => {
      const val = snapshot.val() || {};
      data.schedules[user.uid] = val.schedules || {};
      data.notifications[user.uid] = val.notifications || [];
      data.groups = val.groups || {};
      data.events = val.events || [];
      loadSchedule();
      loadGroups();
      loadEvents();
      loadNotifications();
    });
  }
});


  // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ãˆã‚‹ã‚ˆã†ã«windowã¸ç™»éŒ²
  window.firebaseDB = db;
  window.firebaseRef = ref;
  window.firebaseSet = set;
  window.firebaseOnValue = onValue;
  window.firebaseUpdate = update;
  window.firebaseRemove = remove;
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const eventsRef = firebaseRef(firebaseDB, "events");
  const groupsRef = firebaseRef(firebaseDB, "groups");

  firebaseOnValue(eventsRef, (snapshot) => {
    data.events = snapshot.val() || [];
    if (currentUser) loadEvents();
  });

  firebaseOnValue(groupsRef, (snapshot) => {
    data.groups = snapshot.val() || {};
    if (currentUser) loadGroups();
  });
});
    // ğŸ”¹ ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…±æœ‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å–å¾—ã—ã¦è¡¨ç¤º
function viewSharedSchedule() {
  const uid = document.getElementById('sharedUserId').value.trim();
  if (!uid) {
    showNotification('ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const refShared = firebaseRef(firebaseDB, `sharedSchedules/${uid}`);
  firebaseOnValue(refShared, (snapshot) => {
    const schedule = snapshot.val();
    if (!schedule) {
      showNotification('ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…±æœ‰æ™‚é–“å‰²ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    const tbody = document.getElementById('sharedScheduleBody');
    tbody.innerHTML = '';
    const times = Object.keys(schedule).sort();
    const days = ['æœˆ','ç«','æ°´','æœ¨','é‡‘'];

    times.forEach(time => {
      const row = document.createElement('tr');
      const timeCell = document.createElement('td');
      timeCell.className = 'time-cell';
      timeCell.innerHTML = time.replace('-', '<br>ï½<br>');
      row.appendChild(timeCell);

      days.forEach(day => {
        const cell = document.createElement('td');
        if (schedule[time][day]) {
          const item = document.createElement('div');
          item.className = 'schedule-item';
          item.textContent = schedule[time][day];
          cell.appendChild(item);
        }
        row.appendChild(cell);
      });

      tbody.appendChild(row);
    });

    showNotification('å…±æœ‰æ™‚é–“å‰²ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  });
}
/* ---------- å…¨ãƒªã‚»ãƒƒãƒˆç³»é–¢æ•°ï¼ˆã“ã“ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã®é©åˆ‡ãªå ´æ‰€ã«è¿½åŠ ï¼‰ ---------- */

/** æ™‚é–“å‰²ãƒªã‚»ãƒƒãƒˆï¼ˆç¾åœ¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ™‚é–“å‰²ã‚’ç©ºã«ã™ã‚‹ï¼‰ */
function resetSchedule() {
  if (!currentUser) { showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if (!confirm('æœ¬å½“ã«æ™‚é–“å‰²ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿå…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) return;
  data.schedules[currentUser] = {};
  // Firebase ã«åæ˜ 
  firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/schedules`), data.schedules[currentUser])
    .then(() => {
      loadSchedule();
      showNotification('æ™‚é–“å‰²ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    })
    .catch(() => showNotification('æ™‚é–“å‰²ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
}

/** ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆäºˆå®šï¼‰ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªåˆ†ãŒä¸»å‚¬ã—ã¦ã„ã‚‹äºˆå®šã‚’å‰Šé™¤ï¼‰ */
function resetEvents() {
  if (!currentUser) { showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if (!confirm('è‡ªåˆ†ãŒä½œæˆã—ãŸäºˆå®šã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆå‚åŠ è€…ã®äºˆå®šã¯é™¤ãï¼‰')) return;
  // data.events ãŒé…åˆ—ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å‰æ
  data.events = data.events.filter(e => e.host !== currentUser);
  // Firebase ã®ã‚°ãƒ­ãƒ¼ãƒãƒ« events ã‚’æ›´æ–°
  firebaseSet(firebaseRef(firebaseDB, `events`), data.events)
    .then(() => {
      // è‡ªåˆ†è‡ªèº«ã® users/${uid}/events ã‚‚ç©ºã«
      firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/events`), [])
        .then(() => {
          loadEvents();
          showNotification('äºˆå®šã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        })
        .catch(() => {
          loadEvents();
          showNotification('ä¸€éƒ¨ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶å´ï¼‰ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚°ãƒ­ãƒ¼ãƒãƒ«äºˆå®šã¯æ›´æ–°ã—ã¾ã—ãŸ');
        });
    })
    .catch(() => showNotification('äºˆå®šã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
}

/** é€šçŸ¥ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªåˆ†å®›ã®é€šçŸ¥ã‚’ç©ºã«ã™ã‚‹ï¼‰ */
function resetNotifications() {
  if (!currentUser) { showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if (!confirm('è‡ªåˆ†ã®é€šçŸ¥ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  data.notifications[currentUser] = [];
  firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/notifications`), data.notifications[currentUser])
    .then(() => {
      loadNotifications();
      showNotification('é€šçŸ¥ã‚’å…¨ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
    })
    .catch(() => showNotification('é€šçŸ¥ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
}

/** ã‚°ãƒ«ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªåˆ†ãŒä½œæˆã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã€å‚åŠ ã—ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰è‡ªåˆ†ã‚’å¤–ã™ï¼‰ */
function resetGroups() {
  if (!currentUser) { showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }
  if (!confirm('ä½œæˆã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã€å‚åŠ ä¸­ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰è‡ªåˆ†ã‚’å¤–ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

  const newGroups = {};
  Object.entries(data.groups || {}).forEach(([gid, g]) => {
    // è‡ªåˆ†ãŒä½œæˆè€…ã®å ´åˆã¯ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ï¼ˆï¼ã‚¹ã‚­ãƒƒãƒ—ï¼‰
    if (g.creator === currentUser) {
      return;
    }
    // ãã‚Œä»¥å¤–ã¯ãƒ¡ãƒ³ãƒãƒ¼é…åˆ—ã‹ã‚‰è‡ªåˆ†ã‚’å–ã‚Šé™¤ã
    const members = Array.isArray(g.members) ? g.members.filter(m => m !== currentUser) : [];
    newGroups[gid] = Object.assign({}, g, { members });
  });

  data.groups = newGroups;

  // ã‚°ãƒ­ãƒ¼ãƒãƒ« groups æ›´æ–°ã¨è‡ªåˆ†ã® users/${uid}/groups æ›´æ–°
  firebaseSet(firebaseRef(firebaseDB, `groups`), data.groups)
    .then(() => {
      firebaseSet(firebaseRef(firebaseDB, `users/${currentUser}/groups`), data.groups)
        .then(() => {
          loadGroups();
          showNotification('ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        })
        .catch(() => {
          loadGroups();
          showNotification('ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆãƒ¦ãƒ¼ã‚¶å´ï¼‰ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã¯æ›´æ–°ã—ã¾ã—ãŸ');
        });
    })
    .catch(() => showNotification('ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'));
}

/** å…±æœ‰è¡¨ç¤ºã‚¯ãƒªã‚¢ï¼ˆsharedViewï¼‰ - è¡¨ç¤ºä¸­ã®å…±æœ‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ID ã¨è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢ */
function resetSharedView() {
  document.getElementById('sharedUserId').value = '';
  const tbody = document.getElementById('sharedScheduleBody');
  if (tbody) tbody.innerHTML = '';
  showNotification('å…±æœ‰è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

/* ---------- ã“ã“ã¾ã§å…¨ãƒªã‚»ãƒƒãƒˆé–¢æ•° ---------- */

</script>

</body>
</html>













